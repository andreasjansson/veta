<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veta Agent Chat</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  function App() {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState("");
    const [isConnected, setIsConnected] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const messagesEndRef = useRef(null);
    const wsRef = useRef(null);
    const agentId = useRef(crypto.randomUUID());
    const pendingMessageId = useRef(null);

    useEffect(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    useEffect(() => {
      connectWebSocket();
      return () => {
        if (wsRef.current) {
          wsRef.current.close();
        }
      };
    }, []);

    const connectWebSocket = () => {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${protocol}//${window.location.host}/agents/chat/${agentId.current}`);
      
      ws.onopen = () => {
        setIsConnected(true);
      };

      ws.onclose = () => {
        setIsConnected(false);
        // Reconnect after 2 seconds
        setTimeout(connectWebSocket, 2000);
      };

      ws.onerror = (error) => {
        console.error("WebSocket error:", error);
      };

      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          handleMessage(data);
        } catch (e) {
          console.error("Failed to parse message:", e);
        }
      };

      wsRef.current = ws;
    };

    const handleMessage = (data) => {
      // Skip MCP setup messages
      if (data.type === "cf_agent_mcp_servers") return;

      if (data.type === "cf_agent_use_chat_response") {
        try {
          const body = JSON.parse(data.body);
          
          if (body.type === "text-delta" && body.textDelta) {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg && lastMsg.role === "assistant") {
                lastMsg.content += body.textDelta;
              }
              return [...updated];
            });
          } else if (body.type === "tool-input-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg && lastMsg.role === "assistant") {
                lastMsg.toolCalls = lastMsg.toolCalls || [];
                lastMsg.toolCalls.push({
                  name: body.toolName,
                  input: body.input
                });
              }
              return [...updated];
            });
          } else if (body.type === "tool-output-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg && lastMsg.role === "assistant") {
                lastMsg.toolResults = lastMsg.toolResults || [];
                lastMsg.toolResults.push(body.output);
              }
              return [...updated];
            });
          } else if (body.type === "finish") {
            setIsLoading(false);
          }
        } catch (e) {
          // Body wasn't JSON
        }

        if (data.done) {
          setIsLoading(false);
        }
      }
    };

    const sendMessage = (e) => {
      e.preventDefault();
      if (!input.trim() || isLoading || !isConnected) return;

      const userMessage = { role: "user", content: input };
      setMessages(prev => [...prev, userMessage]);
      
      // Add placeholder for assistant response
      setMessages(prev => [...prev, { role: "assistant", content: "", toolCalls: [], toolResults: [] }]);
      
      const messageId = crypto.randomUUID();
      pendingMessageId.current = messageId;

      // Send via WebSocket
      wsRef.current.send(JSON.stringify({
        type: "cf_agent_use_chat_request",
        id: messageId,
        init: {
          method: "POST",
          body: JSON.stringify({
            messages: [...messages, userMessage].map(m => ({
              id: crypto.randomUUID(),
              role: m.role,
              parts: [{ type: "text", text: m.content }]
            })),
            clientTools: []
          })
        }
      }));

      setInput("");
      setIsLoading(true);
    };

    return (
      <div className="min-h-screen bg-gray-100 flex flex-col">
        <header className="bg-white shadow-sm p-4">
          <h1 className="text-xl font-semibold text-gray-800">Veta Agent Chat</h1>
          <p className="text-sm text-gray-500">
            {isConnected ? "ðŸŸ¢ Connected" : "ðŸ”´ Disconnected"}
          </p>
        </header>

        <main className="flex-1 overflow-y-auto p-4 space-y-4">
          {messages.map((msg, i) => (
            <div key={i} className={`flex ${msg.role === "user" ? "justify-end" : "justify-start"}`}>
              <div className={`max-w-[80%] rounded-lg p-3 ${
                msg.role === "user" ? "bg-blue-500 text-white" : "bg-white shadow"
              }`}>
                <p className="whitespace-pre-wrap">{msg.content}</p>
                {msg.toolCalls?.length > 0 && (
                  <div className="mt-2 pt-2 border-t border-gray-200 text-sm text-gray-600">
                    {msg.toolCalls.map((tc, j) => (
                      <div key={j} className="font-mono text-xs bg-gray-100 p-1 rounded mt-1">
                        ðŸ”§ {tc.name}({JSON.stringify(tc.input)})
                      </div>
                    ))}
                  </div>
                )}
                {msg.toolResults?.length > 0 && (
                  <div className="mt-2 text-sm text-gray-600">
                    {msg.toolResults.map((result, j) => (
                      <div key={j} className="font-mono text-xs bg-green-50 p-1 rounded mt-1">
                        âœ… {result}
                      </div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ))}
          {isLoading && (
            <div className="flex justify-start">
              <div className="bg-white shadow rounded-lg p-3">
                <span className="animate-pulse">Thinking...</span>
              </div>
            </div>
          )}
          <div ref={messagesEndRef} />
        </main>

        <form onSubmit={sendMessage} className="p-4 bg-white shadow-lg">
          <div className="flex gap-2">
            <input
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Ask the agent something..."
              className="flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
              disabled={!isConnected || isLoading}
            />
            <button
              type="submit"
              disabled={!isConnected || isLoading || !input.trim()}
              className="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Send
            </button>
          </div>
        </form>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
