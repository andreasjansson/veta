<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veta Agent Chat</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <style>
    /* CGA 16-color palette */
    :root {
      --cga-black: #000000;
      --cga-blue: #0000AA;
      --cga-green: #00AA00;
      --cga-cyan: #00AAAA;
      --cga-red: #AA0000;
      --cga-magenta: #AA00AA;
      --cga-brown: #AA5500;
      --cga-light-gray: #AAAAAA;
      --cga-dark-gray: #555555;
      --cga-light-blue: #5555FF;
      --cga-light-green: #55FF55;
      --cga-light-cyan: #55FFFF;
      --cga-light-red: #FF5555;
      --cga-light-magenta: #FF55FF;
      --cga-yellow: #FFFF55;
      --cga-white: #FFFFFF;
    }
    * { font-family: "VT323", monospace; }
    html, body, #root { height: 100%; margin: 0; overflow: hidden; }
    body { background: var(--cga-black); color: var(--cga-light-green); font-size: 1.5rem; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  function ToolCall({ toolCall, result }) {
    const [expanded, setExpanded] = useState(false);

    const formatInput = (input) => {
      if (!input || typeof input !== 'object') return null;
      return Object.entries(input).map(([key, value]) => {
        const displayValue = typeof value === 'string' ? value : JSON.stringify(value);
        return (
          <div key={key} className="pl-4">
            <span style={{color: 'var(--cga-cyan)'}}>{key}:</span>{" "}
            <span style={{color: 'var(--cga-light-cyan)'}} className="whitespace-pre-wrap">{displayValue}</span>
          </div>
        );
      });
    };

    return (
      <div className="flex justify-start">
        <div className="max-w-[80%] p-3 border-2" style={{borderColor: 'var(--cga-brown)', backgroundColor: 'rgba(170, 85, 0, 0.1)'}}>
          <button
            onClick={() => setExpanded(!expanded)}
            className="flex items-center gap-2 cursor-pointer text-left w-full"
            style={{color: 'var(--cga-yellow)'}}
          >
            <span style={{color: 'var(--cga-brown)'}}>{expanded ? "[-]" : "[+]"}</span>
            <span>{toolCall.name}</span>
          </button>
          {expanded && (
            <div className="mt-2 pt-2" style={{borderTop: '1px solid var(--cga-brown)'}}>
              {toolCall.input && Object.keys(toolCall.input).length > 0 && (
                <div className="mb-2">
                  <div style={{color: 'var(--cga-brown)'}}>INPUT:</div>
                  {formatInput(toolCall.input)}
                </div>
              )}
              {result !== undefined && (
                <div>
                  <div style={{color: 'var(--cga-brown)'}}>OUTPUT:</div>
                  <div className="pl-4 whitespace-pre-wrap" style={{color: 'var(--cga-light-green)'}}>{result}</div>
                </div>
              )}
            </div>
          )}
        </div>
      </div>
    );
  }

  function App() {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState("");
    const [isConnected, setIsConnected] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const messagesEndRef = useRef(null);
    const inputRef = useRef(null);
    const wsRef = useRef(null);
    const agentId = useRef(crypto.randomUUID());

    useEffect(() => {
      messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
    }, [messages]);

    useEffect(() => {
      if (!isLoading && isConnected) {
        inputRef.current?.focus();
      }
    }, [isLoading, isConnected]);

    useEffect(() => {
      connectWebSocket();
      return () => wsRef.current?.close();
    }, []);

    const connectWebSocket = () => {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${protocol}//${window.location.host}/agents/chat/${agentId.current}`);
      
      ws.onopen = () => setIsConnected(true);
      ws.onclose = () => {
        setIsConnected(false);
        setTimeout(connectWebSocket, 2000);
      };
      ws.onerror = (e) => console.error("WebSocket error:", e);
      ws.onmessage = (event) => {
        try {
          handleMessage(JSON.parse(event.data));
        } catch (e) {}
      };
      wsRef.current = ws;
    };

    const handleMessage = (data) => {
      if (data.type === "cf_agent_mcp_servers") return;

      if (data.type === "cf_agent_use_chat_response") {
        try {
          const body = JSON.parse(data.body);
          
          if (body.type === "tool-input-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") {
                lastMsg.toolCalls = lastMsg.toolCalls || [];
                lastMsg.toolCalls.push({ name: body.toolName, input: body.input });
              }
              return [...updated];
            });
          } else if (body.type === "tool-output-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") {
                lastMsg.toolResults = lastMsg.toolResults || [];
                lastMsg.toolResults.push(body.output);
              }
              return [...updated];
            });
          } else if (body.type === "text-delta" && (body.delta || body.textDelta)) {
            const text = body.delta || body.textDelta;
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") {
                lastMsg.content += text;
              }
              return [...updated];
            });
          } else if (body.type === "finish") {
            setIsLoading(false);
          }
        } catch (e) {}

        if (data.done) setIsLoading(false);
      }
    };

    const sendMessage = (e) => {
      e.preventDefault();
      if (!input.trim() || isLoading || !isConnected) return;

      const userMessage = { role: "user", content: input };
      setMessages(prev => [...prev, userMessage, { role: "assistant", content: "", toolCalls: [], toolResults: [] }]);

      wsRef.current.send(JSON.stringify({
        type: "cf_agent_use_chat_request",
        id: crypto.randomUUID(),
        init: {
          method: "POST",
          body: JSON.stringify({
            messages: [...messages, userMessage].map(m => ({
              id: crypto.randomUUID(),
              role: m.role,
              parts: [{ type: "text", text: m.content }]
            })),
            clientTools: []
          })
        }
      }));

      setInput("");
      setIsLoading(true);
    };

    return (
      <div className="h-full flex flex-col">
        <header className="border-b-2 p-4 flex justify-between items-center" style={{borderColor: 'var(--cga-green)'}}>
          <div className="flex items-center gap-4">
            <h1 style={{color: 'var(--cga-light-green)'}}>VETA AGENT</h1>
            <span style={{color: 'var(--cga-light-gray)'}}>{isConnected ? "[CONNECTED]" : "[DISCONNECTED]"}</span>
          </div>
          <button
            onClick={() => {
              wsRef.current?.close();
              setMessages([]);
              agentId.current = crypto.randomUUID();
              connectWebSocket();
            }}
            className="px-4 py-2 border-2"
            style={{borderColor: 'var(--cga-green)', color: 'var(--cga-light-green)'}}
            onMouseOver={(e) => e.target.style.backgroundColor = 'var(--cga-green)'}
            onMouseOut={(e) => e.target.style.backgroundColor = 'transparent'}
          >
            NEW CHAT
          </button>
        </header>

        <main className="flex-1 min-h-0 overflow-y-auto p-4 space-y-4">
          {messages.map((msg, i) => (
            <React.Fragment key={i}>
              {msg.role === "user" ? (
                <div className="flex justify-end">
                  <div className="max-w-[80%] p-3 border-2" style={{borderColor: 'var(--cga-cyan)', color: 'var(--cga-light-cyan)', backgroundColor: 'rgba(0, 170, 170, 0.1)'}}>
                    <p className="whitespace-pre-wrap">{msg.content}</p>
                  </div>
                </div>
              ) : (
                <>
                  {msg.toolCalls?.map((tc, j) => (
                    <ToolCall 
                      key={`${i}-tool-${j}`} 
                      toolCall={tc} 
                      result={msg.toolResults?.[j]}
                    />
                  ))}
                  {(msg.content || (isLoading && i === messages.length - 1 && !msg.toolCalls?.length)) && (
                    <div className="flex justify-start">
                      <div className="max-w-[80%] p-3 border-2" style={{borderColor: 'var(--cga-green)', color: 'var(--cga-light-green)', backgroundColor: 'rgba(0, 170, 0, 0.1)'}}>
                        {isLoading && i === messages.length - 1 && !msg.content ? (
                          <span className="animate-pulse">_</span>
                        ) : (
                          <p className="whitespace-pre-wrap">{msg.content}</p>
                        )}
                      </div>
                    </div>
                  )}
                </>
              )}
            </React.Fragment>
          ))}
          <div ref={messagesEndRef} />
        </main>

        <form onSubmit={sendMessage} className="p-4 border-t-2" style={{borderColor: 'var(--cga-green)'}}>
          <div className="flex gap-2">
            <span className="py-2" style={{color: 'var(--cga-green)'}}>&gt;</span>
            <input
              ref={inputRef}
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              placeholder="Enter command..."
              className="flex-1 p-2 bg-transparent border-2 focus:outline-none"
              style={{borderColor: 'var(--cga-green)', color: 'var(--cga-light-green)'}}
              disabled={!isConnected || isLoading}
            />
            <button
              type="submit"
              disabled={!isConnected || isLoading || !input.trim()}
              className="px-4 py-2 border-2 disabled:opacity-30 disabled:cursor-not-allowed"
              style={{borderColor: 'var(--cga-green)', color: 'var(--cga-light-green)'}}
            >
              SEND
            </button>
          </div>
        </form>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
