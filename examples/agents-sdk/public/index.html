<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Veta Agent Chat</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            cga: {
              black: '#000000',
              blue: '#0000AA',
              green: '#00AA00',
              cyan: '#00AAAA',
              red: '#AA0000',
              magenta: '#AA00AA',
              brown: '#AA5500',
              'light-gray': '#AAAAAA',
              'dark-gray': '#555555',
              'light-blue': '#5555FF',
              'light-green': '#55FF55',
              'light-cyan': '#55FFFF',
              'light-red': '#FF5555',
              'light-magenta': '#FF55FF',
              yellow: '#FFFF55',
              white: '#FFFFFF',
            }
          }
        }
      }
    }
  </script>
  <style>
    * { font-family: "VT323", monospace; }
    html, body, #root { height: 100%; margin: 0; overflow: hidden; }
    body { font-size: 24px; }

    .box-raised {
      border: 1px solid #FFFFFF;
      box-shadow: inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #555555, 2px 2px 0 #000000;
    }

    .box-inset {
      border: 1px solid #555555;
      box-shadow: inset 1px 1px 0 #555555, inset -1px -1px 0 #AAAAAA;
    }

    .btn {
      background: #AAAAAA;
      color: #000000;
      border: 1px solid #FFFFFF;
      box-shadow: inset 1px 1px 0 #FFFFFF, inset -1px -1px 0 #555555, 1px 1px 0 #000000;
      cursor: pointer;
    }
    .btn:hover { background: #FFFFFF; }
    .btn:active { box-shadow: inset 1px 1px 0 #555555, inset -1px -1px 0 #FFFFFF; }
    .btn:disabled { color: #555555; cursor: not-allowed; }
  </style>
</head>
<body class="bg-cga-black text-cga-white">
  <div id="root"></div>
  <script type="text/babel">
  const { useState, useEffect, useRef } = React;

  function ToolCall({ toolCall, result }) {
    const [expanded, setExpanded] = useState(false);
    return (
      <div className="box-raised bg-cga-brown text-cga-yellow px-4 py-2 mb-4">
        <div onClick={() => setExpanded(!expanded)} className="cursor-pointer">
          <span>{expanded ? "[-]" : "[+]"}</span> {toolCall.name}
        </div>
        {expanded && (
          <div className="mt-2 pt-2 border-t border-cga-yellow">
            {toolCall.input && Object.keys(toolCall.input).length > 0 && (
              <div className="mb-2">
                <div className="text-cga-light-gray">INPUT:</div>
                {Object.entries(toolCall.input).map(([k, v]) => (
                  <div key={k} className="ml-8">
                    <span className="text-cga-white">{k}:</span>{" "}
                    <span className="text-cga-yellow whitespace-pre-wrap">{typeof v === 'string' ? v : JSON.stringify(v)}</span>
                  </div>
                ))}
              </div>
            )}
            {result !== undefined && (
              <div>
                <div className="text-cga-light-gray">OUTPUT:</div>
                <div className="ml-8 text-cga-light-green whitespace-pre-wrap">{result}</div>
              </div>
            )}
          </div>
        )}
      </div>
    );
  }

  function App() {
    const [messages, setMessages] = useState([]);
    const [input, setInput] = useState("");
    const [isConnected, setIsConnected] = useState(false);
    const [isLoading, setIsLoading] = useState(false);
    const messagesEndRef = useRef(null);
    const messagesContainerRef = useRef(null);
    const inputRef = useRef(null);
    const wsRef = useRef(null);
    const agentId = useRef(crypto.randomUUID());
    const shouldAutoScroll = useRef(true);

    useEffect(() => {
      if (shouldAutoScroll.current) {
        messagesEndRef.current?.scrollIntoView({ behavior: "instant" });
      }
    }, [messages]);

    const handleScroll = () => {
      const el = messagesContainerRef.current;
      if (!el) return;
      const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 50;
      shouldAutoScroll.current = atBottom;
    };
    useEffect(() => { if (!isLoading && isConnected) inputRef.current?.focus(); }, [isLoading, isConnected]);
    useEffect(() => { connectWebSocket(); return () => wsRef.current?.close(); }, []);

    const connectWebSocket = () => {
      const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
      const ws = new WebSocket(`${protocol}//${window.location.host}/agents/chat/${agentId.current}`);
      ws.onopen = () => setIsConnected(true);
      ws.onclose = () => { setIsConnected(false); setTimeout(connectWebSocket, 2000); };
      ws.onerror = (e) => console.error("WebSocket error:", e);
      ws.onmessage = (event) => { try { handleMessage(JSON.parse(event.data)); } catch (e) {} };
      wsRef.current = ws;
    };

    const handleMessage = (data) => {
      if (data.type === "cf_agent_mcp_servers") return;
      if (data.type === "cf_agent_use_chat_response") {
        try {
          const body = JSON.parse(data.body);
          if (body.type === "tool-input-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") {
                lastMsg.toolCalls = lastMsg.toolCalls || [];
                lastMsg.toolCalls.push({ name: body.toolName, input: body.input });
              }
              return [...updated];
            });
          } else if (body.type === "tool-output-available") {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") {
                lastMsg.toolResults = lastMsg.toolResults || [];
                lastMsg.toolResults.push(body.output);
              }
              return [...updated];
            });
          } else if (body.type === "text-delta" && (body.delta || body.textDelta)) {
            setMessages(prev => {
              const updated = [...prev];
              const lastMsg = updated[updated.length - 1];
              if (lastMsg?.role === "assistant") lastMsg.content += body.delta || body.textDelta;
              return [...updated];
            });
          } else if (body.type === "finish") {
            setIsLoading(false);
          }
        } catch (e) {}
        if (data.done) setIsLoading(false);
      }
    };

    const sendMessage = (e) => {
      e.preventDefault();
      if (!input.trim() || isLoading || !isConnected) return;
      const userMessage = { role: "user", content: input };
      setMessages(prev => [...prev, userMessage, { role: "assistant", content: "", toolCalls: [], toolResults: [] }]);
      wsRef.current.send(JSON.stringify({
        type: "cf_agent_use_chat_request",
        id: crypto.randomUUID(),
        init: {
          method: "POST",
          body: JSON.stringify({
            messages: [...messages, userMessage].map(m => ({ id: crypto.randomUUID(), role: m.role, parts: [{ type: "text", text: m.content }] })),
            clientTools: []
          })
        }
      }));
      setInput("");
      setIsLoading(true);
    };

    return (
      <div className="w-full h-full bg-cga-light-gray flex flex-col">
        {/* Title bar */}
        <div className="bg-cga-blue text-cga-white px-4 flex justify-between items-center">
          <span>VETA AGENT {isConnected ? "[CONNECTED]" : "[DISCONNECTED]"}</span>
          <button className="btn px-2 my-1 leading-none" onClick={() => { wsRef.current?.close(); setMessages([]); agentId.current = crypto.randomUUID(); connectWebSocket(); setTimeout(() => inputRef.current?.focus(), 100); }}>
            NEW CHAT
          </button>
        </div>

        {/* Message area */}
        <div ref={messagesContainerRef} onScroll={handleScroll} className="box-inset flex-1 m-4 p-4 bg-cga-black text-cga-light-green overflow-y-auto">
          {messages.map((msg, i) => (
            <React.Fragment key={i}>
              {msg.role === "user" ? (
                <div className="text-cga-light-cyan mb-4">
                  <span className="text-cga-cyan">&gt; </span>
                  <span className="whitespace-pre-wrap">{msg.content}</span>
                </div>
              ) : (
                <>
                  {msg.toolCalls?.map((tc, j) => <ToolCall key={`${i}-tool-${j}`} toolCall={tc} result={msg.toolResults?.[j]} />)}
                  {(msg.content || (isLoading && i === messages.length - 1 && !msg.toolCalls?.length)) && (
                    <div className="mb-4 whitespace-pre-wrap">
                      {isLoading && i === messages.length - 1 && !msg.content ? "_" : msg.content}
                    </div>
                  )}
                </>
              )}
            </React.Fragment>
          ))}
          <div ref={messagesEndRef} />
        </div>

        {/* Input area */}
        <form onSubmit={sendMessage} className="flex gap-4 px-4 pb-4">
          <div className="box-inset flex-1 flex bg-cga-black">
            <span className="text-cga-light-green px-4">&gt;</span>
            <input
              ref={inputRef}
              type="text"
              value={input}
              onChange={(e) => setInput(e.target.value)}
              disabled={!isConnected || isLoading}
              className="flex-1 bg-transparent border-none outline-none text-cga-light-green pr-4"
              style={{ font: 'inherit' }}
            />
          </div>
          <button type="submit" disabled={!isConnected || isLoading || !input.trim()} className="btn px-4">SEND</button>
        </form>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
  </script>
</body>
</html>
