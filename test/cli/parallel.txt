%platform unix

=====
reinitialize for parallel tests
=====
veta init --reinitialize
-----
Reinitialized veta database in .veta

=====
parallel adds create unique IDs
=====
for i in $(seq 1 10); do
  veta add --title "Note $i" --tags "parallel" --body "Body $i" &
done
wait
count=$(veta ls parallel -n 0 | wc -l | tr -d ' ')
ids=$(veta ls parallel -n 0 | cut -d: -f1 | sort -n)
unique_count=$(echo "$ids" | sort -u | wc -l | tr -d ' ')
echo "count: $count, unique: $unique_count"
-----
{{ output: string }}
count: {{ count }}, unique: {{ uniq }}
-----
where
* count == 10
* uniq == 10

=====
parallel edits do not corrupt data
=====
veta add --title "Edit target" --tags "editable" --body "Original content"
note_id=$(veta ls editable -n 1 | head -1 | cut -d: -f1)
for i in $(seq 1 5); do
  veta edit $note_id --body "Edit from process $i" &
done
wait
veta show $note_id | grep "Edit target" > /dev/null && echo "note valid: yes"
-----
{{ output: string }}
note valid: yes

=====
sequential test to verify database integrity
=====
veta add --title "Integrity test" --tags "integrity" --body "Original"
id=$(veta ls integrity -n 1 | head -1 | cut -d: -f1)
veta edit $id --body "Edited"
veta show $id | grep "Edited" > /dev/null && echo "integrity: ok"
-----
Added note {{ note_id }}
Edited note {{ edited_id }}: Updated body
integrity: ok
-----
where
* note_id == edited_id
