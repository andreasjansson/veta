===
health check
===
curl -s http://localhost:8787/
---
Veta API

===
create a note
===
curl -s -X POST http://localhost:8787/notes \
  -H "Content-Type: application/json" \
  -d '{"title": "Test note", "body": "Hello world", "tags": ["test", "api"]}' \
  | jq .
---
{
  "id": 1
}

===
create second note
===
curl -s -X POST http://localhost:8787/notes \
  -H "Content-Type: application/json" \
  -d '{"title": "Second note", "body": "Goodbye world", "tags": ["test", "another"]}' \
  | jq .
---
{
  "id": 2
}

===
get a note
===
curl -s http://localhost:8787/notes/1 | jq .
---
{
  "id": 1,
  "title": "Test note",
  "body": "Hello world",
  "tags": [
    "api",
    "test"
  ],
  "updated_at": "{{ updated_at_1 }}"
}

===
get second note
===
curl -s http://localhost:8787/notes/2 | jq .
---
{
  "id": 2,
  "title": "Second note",
  "body": "Goodbye world",
  "tags": [
    "another",
    "test"
  ],
  "updated_at": "{{ updated_at_2 }}"
}

===
list all notes
===
curl -s http://localhost:8787/notes | jq .
---
[
  {
    "id": {{ id_second }},
    "title": "{{ title_second }}",
    "body_preview": "{{ body_second }}",
    "tags": [
      "{{ tag_second_1 }}",
      "{{ tag_second_2 }}"
    ],
    "updated_at": "{{ updated_second }}"
  },
  {
    "id": {{ id_first }},
    "title": "{{ title_first }}",
    "body_preview": "{{ body_first }}",
    "tags": [
      "{{ tag_first_1 }}",
      "{{ tag_first_2 }}"
    ],
    "updated_at": "{{ updated_first }}"
  }
]
---
where
* id_second == 2
* id_first == 1

===
list notes with tag filter
===
curl -s "http://localhost:8787/notes?tags=api" | jq .
---
[
  {
    "id": 1,
    "title": "Test note",
    "body_preview": "Hello world",
    "tags": [
      "api",
      "test"
    ],
    "updated_at": "{{ updated_at }}"
  }
]

===
list notes with limit
===
curl -s "http://localhost:8787/notes?limit=1" | jq .
---
[
  {
    "id": {{ id }},
    "title": "{{ title }}",
    "body_preview": "{{ body }}",
    "tags": [
      "{{ tag1 }}",
      "{{ tag2 }}"
    ],
    "updated_at": "{{ updated }}"
  }
]

===
get non-existent note returns 404
===
curl -s http://localhost:8787/notes/999 | jq .
---
{
  "error": "Not found"
}

===
list tags
===
curl -s http://localhost:8787/tags | jq .
---
[
  {
    "name": "test",
    "count": 2
  },
  {
    "name": "another",
    "count": 1
  },
  {
    "name": "api",
    "count": 1
  }
]

===
grep notes
===
curl -s "http://localhost:8787/grep?q=Hello" | jq .
---
[
  {
    "id": 1,
    "title": "Test note",
    "body_preview": "Hello world",
    "tags": [
      "api",
      "test"
    ],
    "updated_at": "{{ updated_at }}"
  }
]

===
grep case insensitive
===
curl -s "http://localhost:8787/grep?q=hello" | jq .
---
[
  {
    "id": 1,
    "title": "Test note",
    "body_preview": "Hello world",
    "tags": [
      "api",
      "test"
    ],
    "updated_at": "{{ updated_at }}"
  }
]

===
grep case sensitive finds nothing
===
curl -s "http://localhost:8787/grep?q=hello&case_sensitive=true" | jq .
---
[]

===
grep with tag filter
===
curl -s "http://localhost:8787/grep?q=world&tags=another" | jq .
---
[
  {
    "id": 2,
    "title": "Second note",
    "body_preview": "Goodbye world",
    "tags": [
      "another",
      "test"
    ],
    "updated_at": "{{ updated_at }}"
  }
]

===
update note title
===
curl -s -X PATCH http://localhost:8787/notes/1 \
  -H "Content-Type: application/json" \
  -d '{"title": "Updated title"}' \
  | jq .
---
{
  "ok": true
}

===
verify title update
===
curl -s http://localhost:8787/notes/1 | jq .
---
{
  "id": 1,
  "title": "Updated title",
  "body": "Hello world",
  "tags": [
    "api",
    "test"
  ],
  "updated_at": "{{ updated_at }}"
}

===
update note body
===
curl -s -X PATCH http://localhost:8787/notes/1 \
  -H "Content-Type: application/json" \
  -d '{"body": "New body content"}' \
  | jq .
---
{
  "ok": true
}

===
verify body update
===
curl -s http://localhost:8787/notes/1 | jq .
---
{
  "id": 1,
  "title": "Updated title",
  "body": "New body content",
  "tags": [
    "api",
    "test"
  ],
  "updated_at": "{{ updated_at }}"
}

===
update note tags
===
curl -s -X PATCH http://localhost:8787/notes/1 \
  -H "Content-Type: application/json" \
  -d '{"tags": ["updated", "newtag"]}' \
  | jq .
---
{
  "ok": true
}

===
verify tags update
===
curl -s http://localhost:8787/notes/1 | jq .
---
{
  "id": 1,
  "title": "Updated title",
  "body": "New body content",
  "tags": [
    "newtag",
    "updated"
  ],
  "updated_at": "{{ updated_at }}"
}

===
update non-existent note returns 404
===
curl -s -X PATCH http://localhost:8787/notes/999 \
  -H "Content-Type: application/json" \
  -d '{"title": "nope"}' \
  | jq .
---
{
  "error": "Not found"
}

===
delete a note
===
curl -s -X DELETE http://localhost:8787/notes/2 | jq .
---
{
  "ok": true
}

===
verify deletion - list shows one note
===
curl -s http://localhost:8787/notes | jq .
---
[
  {
    "id": 1,
    "title": "Updated title",
    "body_preview": "New body content",
    "tags": [
      "newtag",
      "updated"
    ],
    "updated_at": "{{ updated_at }}"
  }
]

===
delete non-existent note returns 404
===
curl -s -X DELETE http://localhost:8787/notes/999 | jq .
---
{
  "error": "Not found"
}

===
verify tags updated after deletion
===
curl -s http://localhost:8787/tags | jq .
---
[
  {
    "name": "newtag",
    "count": 1
  },
  {
    "name": "updated",
    "count": 1
  }
]
